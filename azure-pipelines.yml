trigger:
- main  # or your desired branch

pool:
  name: 'Default'  # your self-hosted Windows agent pool

steps:
# --- Step 1: Initialize ---
- powershell: |
    Write-Host "Starting build on Windows self-hosted agent..."
  displayName: "Initialize"

# --- Step 2: Install dependencies ---
- powershell: |
    python -m venv venv
    .\venv\Scripts\activate
    pip install --upgrade pip
    pip install -r requirements.txt

    # Install test dependencies
    pip install pytest pytest-cov
  displayName: "Install dependencies"

# --- Step 3: Run tests with coverage ---
- powershell: |
    .\venv\Scripts\activate

    Write-Host "Running tests with coverage..."
    pytest --cov=app --cov-report=xml --cov-report=term-missing tests/

    Write-Host "Tests completed. Coverage report generated as coverage.xml"
  displayName: "Run tests with code coverage"

# --- Step 4: Publish code coverage results ---
- task: PublishCodeCoverageResults@2
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: 'coverage.xml'
    reportDirectory: ''
    failIfCoverageEmpty: true
  displayName: "Publish code coverage report"

# --- Step 5: Run Flask app and test response ---
- powershell: |
    .\venv\Scripts\activate

    # Start Flask app in background
    Start-Process -FilePath "python" -ArgumentList "app.py"
    Write-Host "Flask app started, waiting 10 seconds..."
    Start-Sleep -Seconds 10

    # Test response
    try {
        $response = curl http://127.0.0.1:5000
        Write-Host "Response from Flask app:"
        Write-Host $response.Content
    } catch {
        Write-Error "Failed to connect to Flask app."
        exit 1
    }

    # Kill the Flask app process
    Get-Process python | Where-Object { $_.Path -like "*venv*" } | Stop-Process -Force
  displayName: "Run Flask app and test response"

# --- Step 6: Publish artifact for release pipeline ---
- task: CopyFiles@2
  inputs:
    Contents: '**'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
  displayName: "Copy project files"

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'drop'
  displayName: "Publish artifact for release pipeline"
