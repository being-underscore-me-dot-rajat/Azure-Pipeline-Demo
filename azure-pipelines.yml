trigger:
- main  # or your desired branch

pool:
  name: 'Default'  # your self-hosted Windows agent pool

steps:
# --- Step 1: Initialize ---
- powershell: |
    Write-Host "Starting build on Windows self-hosted agent..."
  displayName: "Initialize"

# --- Step 2: Install dependencies ---
- powershell: |
    python -m venv venv
    .\venv\Scripts\activate
    pip install --upgrade pip
    pip install -r requirements.txt
  displayName: "Install dependencies"

# --- Step 3: Run Flask app and test response ---
- powershell: |
    .\venv\Scripts\activate

    # Start Flask app in background
    Start-Process -FilePath "python" -ArgumentList "app.py"
    Write-Host "Flask app started, waiting 10 seconds..."
    Start-Sleep -Seconds 10

    # Test response
    try {
        $response = curl http://127.0.0.1:5000
        Write-Host "Response from Flask app:"
        Write-Host $response.Content
    } catch {
        Write-Error "Failed to connect to Flask app."
        exit 1
    }

    # Kill the Flask app process
    Get-Process python | Where-Object { $_.Path -like "*venv*" } | Stop-Process -Force
  displayName: "Run Flask app and test response"
